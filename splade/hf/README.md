# SPLADE - HuggingFace training

**TL; DR** We provide a new code version to train SPLADE models based on HuggingFace trainers. Compared to the original code base, it allows training SPLADE with several *hard* negatives, training with Distributed Data Parallel etc., making the overall training process more effective and efficient. 
It also differs in various aspects -- for instance, we remove the scheduler for the regularization hyperparameters, add the "anti-zero" trick to avoid representations collapsing to zero vectors etc. 

This code is solely meant to **train** models. To index and retrieve with SPLADE, everything remains the same. Tested with:

```pip install torch transformers==4.29.2  hydra-core faiss-cpu pytest numba h5py pytrec_eval tensorboard  accelerate  matplotlib```

## Data format

To train models, four files are needed (used in the `src/hf/datasets.py` file):

* **collection file** : *tsv* file, `ID\tDATA`, contains the (text) documents
* **query file** : *tsv* file, `ID\tDATA`, contains the (text) queries
* **qrel file** : *json* file, `{QID: {DID_1: rel_1, DID_2: rel_2, ...}, ...}`, ground-truth relevance
* **score (or hard-negative file)** : here, we allow for several formats
    * **saved_pkl** (resp. **pkl_dict**) : pickle file (resp. gzip), *json* format, `{QID: {DID_1: score_1, DID_2: score_2, ...}, ...}` (the latter having the format of `cross-encoder-ms-marco-MiniLM-L-6-v2-scores.pkl.gz` from this [page](https://huggingface.co/datasets/sentence-transformers/msmarco-hard-negatives/tree/main), where the file is compressed and the ids are integers)
    * **trec** : trec format file (e.g., generated by Anserini)
    * **json** : dict result from a run, *json* format ; for instance to train a SPLADE model with SPLADE negatives (from a first round of training)

Note that training w/o distillation still relies on a "score" file (but the scores are not used).

## Getting started

To keep full backward compatibility with the original SPLADE code, we allow training models with [Hydra](https://hydra.cc/) configurations. The mapping between hyperparameters is done in `splade/hf/convertl2i2hf.py`.


### Toy example: training a SPLADE model
In particular, training can be launched with :

```
torchrun --nproc_per_node 2 -m splade.hf_train --config-name=config_hf_splade_l1q.yaml  config.checkpoint_dir=<foopath_chk>

```

### Toy example: Indexing a colelction with SPLADE model
After training, indexing and retrieval can be launched with :

```

python  -m splade.index --config-dir=<foopath_chk> --config-name=config config.index_dir=<foopath_index>

python   -m splade.retrieve - --config-dir=/scratch/2/user/hdejean/expfoo/be3/ --config-name=config config.index_dir=<foopath_index> config.out_dir=<foopath_out>

```

### Toy example: training a reranker
You can now train your reranker using the SPLADE output:
```

python -m splade.hf_train_reranker --config-name=config_reranker_train_toy

```
### Toy example: Reranker a SPLADE output

Then  you can apply your reranker:
```

python -m splade.rerank --config-name=config_reranker_toy data.path_run=[<foopath_out>/run.json]

```




